# Investigation Log: K8s 1.33 User Namespace Issue

**Date:** 2026-02-04  
**Branch:** fix/sysbox-1.33  
**Agent:** GitHub Copilot (Claude Opus 4.5)

## Objective

Investigate why Sysbox fails on Kubernetes 1.33 with the error:
```
reading ID mappings from "/proc/0/uid_map": open /proc/0/uid_map: no such file or directory: CreateContainerError
```

## Investigation Steps

### 1. Project Structure Analysis
- Identified submodules: sysbox-runc, sysbox-mgr, sysbox-fs, sysbox-libs, sysbox-ipc, sysbox-pkgr
- Main components are in Go, build system uses Makefiles
- K8s deployment via DaemonSet in sysbox-pkgr/k8s/

### 2. GitHub Issue #961 Review
- Fetched https://github.com/nestybox/sysbox/issues/961
- Community confirms issue on AKS, GKE, EKS with K8s 1.33
- Workaround: disable `UserNamespacesSupport` feature gate (not possible on managed K8s)
- Some users report building from source doesn't help

### 3. Error Source Identification
- Searched for "uid_map" references in codebase
- Found key file: `sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go`
- Function `GetUserNamespaceMappings()` parses `/proc/<pid>/ns/user` path
- When pid=0 (invalid), constructs path `/proc/0/uid_map` which doesn't exist

### 4. Kubernetes User Namespace Documentation
- Reviewed https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/
- K8s 1.30: UserNamespacesSupport in beta
- K8s 1.33: Enabled by default
- Kubelet creates userns, passes path to runtime
- Runtime expected to JOIN existing userns, not create new one

### 5. Code Flow Analysis

#### User Namespace Path in OCI Spec
```
spec.Linux.Namespaces contains:
  Type: "user"
  Path: "/proc/<pid>/ns/user"  <- When K8s provides userns
  Path: ""                      <- When runtime should create userns
```

#### Sysbox's Assumption
Sysbox assumes `Path: ""` and creates its own userns via:
1. `cfgNamespaces()` in spec.go - adds user namespace if missing
2. `cfgIDMappings()` - allocates IDs from sysbox-mgr
3. `allocIDMappings()` - calls `sysMgr.ReqSubid()`

#### The Conflict
When K8s provides `Path: "/proc/<pid>/ns/user"`:
1. Sysbox tries to read mappings from that path
2. `GetUserNamespaceMappings()` parses pid from path
3. If pid is 0 or process no longer exists, read fails

### 6. Key Files Identified

| File | Lines | Purpose |
|------|-------|---------|
| sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go | 1-200 | Read userns mappings |
| sysbox-runc/libsysbox/syscont/spec.go | 280-450 | OCI spec configuration |
| sysbox-runc/libcontainer/specconv/spec_linux.go | 1080-1128 | setupUserNamespace() |
| sysbox-mgr/mgr.go | 508-600 | Container registration |
| sysbox-pkgr/k8s/scripts/sysbox-deploy-k8s.sh | 780-810 | K8s version check |

### 7. Upstream runc Comparison
- Searched opencontainers/runc for similar code
- Found same `GetUserNamespaceMappings()` pattern
- Upstream has same potential issue but handles it differently
- Upstream falls back to "slow path" (spawn into userns) more robustly

## Files Changed

None yet - investigation only.

## Commands Run

```bash
git checkout -b fix/sysbox-1.33
```

## Next Steps

1. Implement detection of external user namespace in spec.go
2. Add logic to skip ID allocation when using K8s-provided userns
3. Improve error handling in userns_maps_linux.go
4. Test on K8s 1.33 cluster
5. Update sysbox-deploy-k8s.sh if needed

## Insights Generated

Created insight file: `.agents/insights/k8s-1.33-user-namespace-issue.md`

## References

- GitHub Issue: https://github.com/nestybox/sysbox/issues/961
- K8s User Namespaces: https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/
- KEP-127: https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/127-user-namespaces

## Corrections / Follow-ups (2026-02-04)

- Agent identity: this log lists "GitHub Copilot (Claude Opus 4.5)"; for this workspace, the agent is GitHub Copilot using GPT-5.2.
- Code reality check: in the current `sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go`, `GetUserNamespaceMappings()` only attempts the `/proc/<pid>/{uid,gid}_map` fast path when `pid > 0`; otherwise it falls back to a slow userns-join path. This makes the earlier "/proc/0/uid_map fast-path" theory incomplete for this source snapshot.
