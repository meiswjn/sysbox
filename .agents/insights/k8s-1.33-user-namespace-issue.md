# Sysbox K8s 1.33 User Namespace Compatibility Issue

**Created:** 2026-02-04  
**Status:** Open - Needs Code Fix  
**Severity:** Critical - Blocks K8s 1.33+ Deployments  
**Related Issue:** https://github.com/nestybox/sysbox/issues/961

## Summary

Sysbox fails to start containers on Kubernetes 1.33+ with the error:
```
reading ID mappings from "/proc/0/uid_map": open /proc/0/uid_map: no such file or directory: CreateContainerError
```

This affects **all managed Kubernetes services** (AKS, GKE, EKS) running K8s 1.33+ because the `UserNamespacesSupport` feature gate is enabled by default and cannot be disabled.

## Root Cause

### Kubernetes 1.33 User Namespace Feature

Starting with K8s 1.30 (beta) and enabled by default in 1.33:
- The kubelet creates and manages user namespaces for pods
- CRI-O/containerd passes an existing user namespace path to the runtime
- The runtime is expected to **join** the namespace, not create one

### Sysbox's Design Conflict

Sysbox was designed to **create and manage its own user namespaces**:
- sysbox-mgr allocates UID/GID ranges
- sysbox-runc creates new user namespaces during container creation
- Sysbox expects exclusive control of the container's user namespace

### Important Correction (2026-02-04)

The above hypothesis ("pid=0 leads to `/proc/0/uid_map`") does **not** match the current implementation in this workspace.

In `sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go`, `GetUserNamespaceMappings()` only attempts the `/proc/<pid>/{uid,gid}_map` *fast path* when `pid > 0`. If `pid <= 0` or the `nsPath` does not match `/proc/<pid>/ns/user` exactly, it falls back to a *slow path* that joins the namespace and reads `/proc/self/{uid,gid}_map` from inside it.

As a result, an error that specifically says it tried to open `/proc/0/uid_map` is likely coming from:
- A different code path than `GetUserNamespaceMappings()`.
- Or a different binary build / release artifact than the source currently in this workspace.
- Or a runtime-provided `nsPath` (e.g., `/proc/0/ns/user`) that fails earlier (namespace join) and is being reported by another layer.

### What We Still Believe Is Happening

The design conflict with K8s-managed user namespaces remains plausible:
- K8s can provide an existing userns via `spec.linux.namespaces[].path`.
- Sysbox historically expects to control userns creation and ID allocation.

But the *exact* source of the `/proc/0/uid_map` error needs confirmation with real runtime logs (CRI-O + sysbox-runc debug logs) from a failing K8s 1.33+ deployment.

## Affected Components

1. **sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go** - `GetUserNamespaceMappings()`
2. **sysbox-runc/libcontainer/specconv/spec_linux.go** - `setupUserNamespace()`
3. **sysbox-runc/libsysbox/syscont/spec.go** - `cfgNamespaces()`, `cfgIDMappings()`
4. **sysbox-mgr/mgr.go** - `register()` - ID allocation logic

## Key Files for Fix

| File | Purpose | Changes Needed |
|------|---------|----------------|
| `sysbox-runc/libsysbox/syscont/spec.go` | OCI spec configuration | Detect external userns, skip ID allocation |
| `sysbox-runc/libcontainer/specconv/spec_linux.go` | Libcontainer config setup | Handle pre-existing userns path |
| `sysbox-runc/libcontainer/internal/userns/userns_maps_linux.go` | Read userns mappings | Better error handling, fallback to slow path |
| `sysbox-mgr/mgr.go` | Container registration | Skip subid allocation when using external userns |

## Required Changes (High-Level)

### 1. Detect External User Namespace
In `sysbox-runc/libsysbox/syscont/spec.go`, the `cfgNamespaces()` function needs to:
- Check if `spec.Linux.Namespaces` contains a user namespace with non-empty `Path`
- If path is set, this is an external userns managed by K8s

### 2. Skip ID Allocation for External Userns
In `cfgIDMappings()`:
- If external userns detected, read mappings from the namespace instead of allocating
- Validate mappings meet Sysbox requirements (min 65536 IDs)
- Pass external userns info to sysbox-mgr

### 3. Handle Invalid PID in Mapping Reader
In `GetUserNamespaceMappings()`:
- **Already true in this workspace:** fast path only runs when `pid > 0`; otherwise it uses the slow path.
- If the observed error persists, focus on identifying the actual call site producing `/proc/0/uid_map` (see "Next verification steps" below).

### 4. sysbox-mgr Registration
In `mgr.go` `register()`:
- Accept flag indicating external userns
- Skip `ReqSubid()` call when using external userns
- Store external userns mappings in container info

## Workarounds

### For Self-Managed Clusters
Disable the feature gate:
```yaml
# kubelet configuration
featureGates:
  UserNamespacesSupport: false
```

### For Managed K8s (AKS, GKE, EKS)
**No workaround available** - feature cannot be disabled. Must either:
- Stay on K8s 1.32 or earlier
- Wait for Sysbox fix
- Use alternative isolation (Kata, gVisor, native K8s userns)

## Testing Considerations

When implementing a fix, test:
1. K8s 1.33 with UserNamespacesSupport enabled (default)
2. K8s 1.32 with UserNamespacesSupport disabled (existing behavior)
3. K8s 1.32 with UserNamespacesSupport enabled (manual enable)
4. Pods with `hostUsers: false` (explicit userns request)
5. Pods with `hostUsers: true` (opt-out of userns)
6. Multiple containers sharing netns/userns

## Next Verification Steps (2026-02-04)

1. Capture sysbox-runc debug logs during failing pod creation (enable logrus debug if needed).
2. Capture the OCI spec passed by CRI-O to sysbox-runc (look for `linux.namespaces` user entry and its `path`).
3. Determine where `/proc/0/uid_map` is referenced in the deployed sysbox-runc binary (string search) to confirm whether the running binary matches this source tree.
4. If the failing cluster is managed, confirm whether the userns path is stable and points to a real process in `/proc`, or whether it points to something else (e.g., a bind-mounted ns file).

## Related Kubernetes Documentation

- [User Namespaces in K8s](https://kubernetes.io/docs/concepts/workloads/pods/user-namespaces/)
- [KEP-127: User Namespaces](https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/127-user-namespaces)
- K8s requires Linux 6.3+ for idmap mounts on tmpfs
- K8s assigns UIDs starting at 65536 with 65536 IDs per pod by default

## Build Notes

The `sysbox-pkgr/k8s/Makefile` downloads pre-built sysbox-mgr and sysbox-fs from releases but builds sysbox-runc from source:

```makefile
fetch-sysbox-ce-bins:
    wget .../sysbox-ce_$(SYSBOX_CE_VER_FULL).linux_$(SYS_ARCH).deb
    # Extract and then overwrite sysbox-runc:
    cp ../../sysbox-runc/build/amd64/sysbox-runc bin/sysbox-ce/generic/sysbox-runc
```

For a proper fix, ALL components must be built from source to ensure consistency.
